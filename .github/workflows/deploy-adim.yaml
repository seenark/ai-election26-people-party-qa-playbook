name: Deploy Admin
on:
  push:
    branches:
      - main
    paths:
      - apps/admin/**
  workflow_dispatch:
jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    env:
      VITE_API_URL: ${{ vars.VITE_API_URL }}
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            /*
            !policies-markdown
          sparse-checkout-cone-mode: false
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        run: |
          docker build --build-arg VITE_API_URL="${{ env.VITE_API_URL }}" -f apps/admin/Dockerfile -t admin .
          docker save admin:latest > admin.tar
      - name: Copy image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.DEPLOY_HOST }}
          port: ${{ env.DEPLOY_PORT }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          source: "admin.tar"
          target: "/home/${{ env.DEPLOY_USER }}/"
      - name: Deploy container
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ env.DEPLOY_HOST }}
          port: ${{ env.DEPLOY_PORT }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.SSH_PRIVATE_KEY }}
          script: |
            # Stop and remove old container
            docker container rm -f admin || true
            docker image rm -f admin:latest || true

            # Load new image
            docker load -i /home/${{ env.DEPLOY_USER }}/admin.tar

            # Start new container
            docker run -d \
              --name admin \
              --restart unless-stopped \
              --network election \
              admin:latest

            # Cleanup
            rm /home/${{ env.DEPLOY_USER }}/admin.tar

            # Show status
            docker ps | grep admin
            docker logs --tail 20 admin